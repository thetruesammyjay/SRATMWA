{% extends "base.html" %}
{% block content %}
<div class="top-bar">
  <h2>⚠️ Risk Register</h2>
  <div class="actions">
    <button class="btn btn-primary" onclick="openModal('risk-modal')">+ New Risk</button>
  </div>
</div>

<div class="page-content">
  <div id="alert-container"></div>

  <div class="filter-bar">
    <select id="filter-level" onchange="loadRisks()">
      <option value="">All Levels</option>
      <option>Critical</option><option>High</option><option>Medium</option><option>Low</option>
    </select>
    <select id="filter-status" onchange="loadRisks()">
      <option value="">All Statuses</option>
      <option>Open</option><option>In Progress</option><option>Closed</option>
    </select>
  </div>

  <div class="card">
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>ID</th><th>Title</th><th>Likelihood</th><th>Impact</th>
            <th>Score</th><th>Level</th><th>Treatment</th><th>Owner</th><th>Status</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="risks-tbody">
          <tr><td colspan="10" style="text-align:center;color:var(--text-muted);padding:40px">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Risk Modal -->
<div class="modal-overlay" id="risk-modal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('risk-modal')">✕</button>
    <h3 id="risk-modal-title">New Risk Entry</h3>

    <div class="form-row">
      <div class="form-group"><label>Title *</label><input id="r-title" placeholder="Risk title" /></div>
      <div class="form-group"><label>Component (for ID)</label><input id="r-comp" placeholder="e.g. AUTH" maxlength="4" /></div>
    </div>
    <div class="form-group"><label>Description</label><textarea id="r-desc"></textarea></div>
    <div class="form-row">
      <div class="form-group"><label>Likelihood (1–10)</label><input id="r-like" type="number" min="1" max="10" value="5" /></div>
      <div class="form-group"><label>Impact (1–10)</label><input id="r-impact" type="number" min="1" max="10" value="5" /></div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Treatment</label>
        <select id="r-treat">
          <option>Mitigate</option><option>Accept</option><option>Transfer</option><option>Avoid</option>
        </select>
      </div>
      <div class="form-group">
        <label>Status</label>
        <select id="r-status">
          <option>Open</option><option>In Progress</option><option>Closed</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Owner</label><input id="r-owner" placeholder="Team or individual" /></div>
      <div class="form-group"><label>Due Date</label><input id="r-due" type="date" /></div>
    </div>
    <div class="form-group"><label>Notes</label><textarea id="r-notes"></textarea></div>
    <div class="form-actions">
      <button class="btn btn-ghost" onclick="closeModal('risk-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveRisk()">Save Risk</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let editRiskId = null;

async function loadRisks() {
  const level  = document.getElementById("filter-level").value;
  const status = document.getElementById("filter-status").value;
  let url = "/api/risks/?";
  if (level)  url += `level=${encodeURIComponent(level)}&`;
  if (status) url += `status=${encodeURIComponent(status)}`;
  const risks = await API.get(url);
  const tbody = document.getElementById("risks-tbody");
  if (!risks.length) {
    tbody.innerHTML = `<tr><td colspan="10"><div class="empty-state"><div class="icon">⚠️</div><p>No risks recorded yet.</p></div></td></tr>`;
    return;
  }
  tbody.innerHTML = risks.map(r => `
    <tr>
      <td><code style="font-size:11px;color:var(--text-muted)">${r.risk_id}</code></td>
      <td>${r.title}</td>
      <td style="text-align:center">${r.likelihood}</td>
      <td style="text-align:center">${r.impact}</td>
      <td style="text-align:center;font-weight:700">${r.risk_score}</td>
      <td>${riskBadge(r.risk_level)}</td>
      <td style="font-size:12px">${r.treatment}</td>
      <td style="font-size:12px;color:var(--text-muted)">${r.owner || '—'}</td>
      <td>${statusBadge(r.status)}</td>
      <td>
        <button class="btn btn-ghost btn-sm" onclick='editRisk(${JSON.stringify(r)})'>Edit</button>
        <button class="btn btn-danger btn-sm" onclick="deleteRisk(${r.id})">Del</button>
      </td>
    </tr>`).join("");
}

function editRisk(r) {
  editRiskId = r.id;
  document.getElementById("risk-modal-title").textContent = "Edit Risk";
  document.getElementById("r-title").value  = r.title;
  document.getElementById("r-desc").value   = r.description || "";
  document.getElementById("r-like").value   = r.likelihood;
  document.getElementById("r-impact").value = r.impact;
  document.getElementById("r-treat").value  = r.treatment;
  document.getElementById("r-status").value = r.status;
  document.getElementById("r-owner").value  = r.owner || "";
  document.getElementById("r-due").value    = r.due_date || "";
  document.getElementById("r-notes").value  = r.notes || "";
  openModal("risk-modal");
}

async function saveRisk() {
  const payload = {
    title: document.getElementById("r-title").value.trim(),
    component: document.getElementById("r-comp").value || "GEN",
    description: document.getElementById("r-desc").value,
    likelihood: parseInt(document.getElementById("r-like").value),
    impact: parseInt(document.getElementById("r-impact").value),
    treatment: document.getElementById("r-treat").value,
    status: document.getElementById("r-status").value,
    owner: document.getElementById("r-owner").value,
    due_date: document.getElementById("r-due").value,
    notes: document.getElementById("r-notes").value,
  };
  if (!payload.title) return showAlert("Title is required.", "error");
  const result = editRiskId
    ? await API.put(`/api/risks/${editRiskId}`, payload)
    : await API.post("/api/risks/", payload);
  if (result.error) return showAlert(result.error, "error");
  closeModal("risk-modal");
  editRiskId = null;
  document.getElementById("risk-modal-title").textContent = "New Risk Entry";
  loadRisks();
  showAlert("Risk saved.");
}

async function deleteRisk(id) {
  if (!confirm("Delete this risk?")) return;
  await API.delete(`/api/risks/${id}`);
  loadRisks();
  showAlert("Risk deleted.");
}

loadRisks();
</script>
{% endblock %}

{% extends "base.html" %}
{% block content %}
<div class="top-bar">
  <h2>✅ Security Checklists</h2>
  <div class="actions">
    <button class="btn btn-ghost" onclick="loadProgress()">↻ Refresh Progress</button>
    <button class="btn btn-primary" onclick="openModal('check-modal')">+ Add Item</button>
  </div>
</div>

<div class="page-content">
  <div id="alert-container"></div>

  <!-- Progress bar -->
  <div class="card" style="margin-bottom:20px">
    <div class="card-header">
      <span class="card-title">Overall Checklist Completion</span>
      <span id="progress-label" style="font-size:13px;color:var(--text-muted)">—</span>
    </div>
    <div class="progress-wrap">
      <div class="progress-fill" id="progress-fill" style="width:0%"></div>
    </div>
    <div style="display:flex;gap:20px;margin-top:10px;font-size:12px;color:var(--text-muted)">
      <span>✅ Pass: <strong id="cnt-pass">0</strong></span>
      <span>❌ Fail: <strong id="cnt-fail">0</strong></span>
      <span>➖ N/A: <strong id="cnt-na">0</strong></span>
      <span>❓ Not Checked: <strong id="cnt-nc">0</strong></span>
    </div>
  </div>

  <!-- Filter -->
  <div class="filter-bar">
    <select id="filter-domain" onchange="loadChecklist()">
      <option value="">All Domains</option>
    </select>
    <select id="filter-status" onchange="loadChecklist()">
      <option value="">All Statuses</option>
      <option>Pass</option><option>Fail</option><option>N/A</option><option>Not Checked</option>
    </select>
  </div>

  <div class="card">
    <div class="table-wrap">
      <table>
        <thead>
          <tr><th>Code</th><th>Domain</th><th>Description</th><th>Reference</th><th>Status</th><th>Actions</th></tr>
        </thead>
        <tbody id="check-tbody">
          <tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:40px">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="check-modal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('check-modal')">✕</button>
    <h3 id="check-modal-title">Add Checklist Item</h3>
    <div class="form-row">
      <div class="form-group"><label>Domain *</label><input id="ci-domain" placeholder="e.g. Authentication" /></div>
      <div class="form-group"><label>Item Code</label><input id="ci-code" placeholder="e.g. AUTH-01" /></div>
    </div>
    <div class="form-group"><label>Description *</label><textarea id="ci-desc" placeholder="Checklist verification item…"></textarea></div>
    <div class="form-row">
      <div class="form-group"><label>Reference</label><input id="ci-ref" placeholder="e.g. ASVS 2.1.1" /></div>
      <div class="form-group">
        <label>Status</label>
        <select id="ci-status">
          <option>Not Checked</option><option>Pass</option><option>Fail</option><option>N/A</option>
        </select>
      </div>
    </div>
    <div class="form-group"><label>Notes</label><textarea id="ci-notes"></textarea></div>
    <div class="form-actions">
      <button class="btn btn-ghost" onclick="closeModal('check-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveItem()">Save</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let editCheckId = null;

async function loadProgress() {
  const p = await API.get("/api/checklists/progress");
  document.getElementById("progress-fill").style.width = p.completion_pct + "%";
  document.getElementById("progress-label").textContent = p.completion_pct + "% complete";
  document.getElementById("cnt-pass").textContent = p.passed;
  document.getElementById("cnt-fail").textContent = p.failed;
  document.getElementById("cnt-na").textContent   = p.na;
  document.getElementById("cnt-nc").textContent  = p.not_checked;
}

async function loadDomains() {
  const domains = await API.get("/api/checklists/domains");
  const sel = document.getElementById("filter-domain");
  domains.forEach(d => {
    const o = document.createElement("option");
    o.value = o.textContent = d;
    sel.appendChild(o);
  });
}

async function loadChecklist() {
  const domain = document.getElementById("filter-domain").value;
  const status = document.getElementById("filter-status").value;
  let url = "/api/checklists/?";
  if (domain) url += `domain=${encodeURIComponent(domain)}&`;
  if (status) url += `status=${encodeURIComponent(status)}`;
  const items = await API.get(url);
  const tbody = document.getElementById("check-tbody");
  if (!items.length) {
    tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="icon">✅</div><p>No checklist items found.</p></div></td></tr>`;
    return;
  }
  tbody.innerHTML = items.map(i => `
    <tr>
      <td><code style="font-size:11px">${i.item_code || '—'}</code></td>
      <td><span class="badge badge-info">${i.domain}</span></td>
      <td style="max-width:320px">${i.description}</td>
      <td style="font-size:12px;color:var(--text-muted)">${i.reference || '—'}</td>
      <td>
        <select class="status-quick" onchange="quickStatus(${i.id}, this.value)"
          style="background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:4px 6px;font-size:12px">
          <option ${i.status==='Not Checked'?'selected':''}>Not Checked</option>
          <option ${i.status==='Pass'?'selected':''}>Pass</option>
          <option ${i.status==='Fail'?'selected':''}>Fail</option>
          <option ${i.status==='N/A'?'selected':''}>N/A</option>
        </select>
      </td>
      <td>
        <button class="btn btn-ghost btn-sm" onclick='editItem(${JSON.stringify(i)})'>Edit</button>
        <button class="btn btn-danger btn-sm" onclick="deleteItem(${i.id})">Del</button>
      </td>
    </tr>`).join("");
}

async function quickStatus(id, status) {
  await API.put(`/api/checklists/${id}`, { status });
  loadProgress();
}

function editItem(i) {
  editCheckId = i.id;
  document.getElementById("check-modal-title").textContent = "Edit Checklist Item";
  document.getElementById("ci-domain").value = i.domain;
  document.getElementById("ci-code").value   = i.item_code || "";
  document.getElementById("ci-desc").value   = i.description;
  document.getElementById("ci-ref").value    = i.reference || "";
  document.getElementById("ci-status").value = i.status;
  document.getElementById("ci-notes").value  = i.notes || "";
  openModal("check-modal");
}

async function saveItem() {
  const payload = {
    domain: document.getElementById("ci-domain").value.trim(),
    item_code: document.getElementById("ci-code").value,
    description: document.getElementById("ci-desc").value.trim(),
    reference: document.getElementById("ci-ref").value,
    status: document.getElementById("ci-status").value,
    notes: document.getElementById("ci-notes").value,
  };
  if (!payload.domain || !payload.description) return showAlert("Domain and description are required.", "error");
  const result = editCheckId
    ? await API.put(`/api/checklists/${editCheckId}`, payload)
    : await API.post("/api/checklists/", payload);
  if (result.error) return showAlert(result.error, "error");
  closeModal("check-modal");
  editCheckId = null;
  document.getElementById("check-modal-title").textContent = "Add Checklist Item";
  loadChecklist();
  loadProgress();
  showAlert("Checklist item saved.");
}

async function deleteItem(id) {
  if (!confirm("Delete this item?")) return;
  await API.delete(`/api/checklists/${id}`);
  loadChecklist();
  loadProgress();
  showAlert("Item deleted.");
}

loadProgress();
loadDomains();
loadChecklist();
</script>
{% endblock %}

{% extends "base.html" %}
{% block content %}
<div class="top-bar">
  <h2>ðŸ”’ Security Controls</h2>
  <div class="actions">
    <button class="btn btn-primary" onclick="openModal('ctrl-modal')">+ New Control</button>
  </div>
</div>

<div class="page-content">
  <div id="alert-container"></div>
  <div class="filter-bar">
    <select id="filter-type" onchange="loadControls()">
      <option value="">All Types</option>
      <option>Preventive</option><option>Detective</option><option>Corrective</option>
    </select>
    <select id="filter-status" onchange="loadControls()">
      <option value="">All Statuses</option>
      <option>Not Implemented</option><option>Partially Implemented</option><option>Implemented</option>
    </select>
  </div>
  <div class="card">
    <div class="table-wrap">
      <table>
        <thead>
          <tr><th>ID</th><th>Title</th><th>Type</th><th>NIST</th><th>OWASP</th><th>Status</th><th>Owner</th><th>Actions</th></tr>
        </thead>
        <tbody id="ctrl-tbody">
          <tr><td colspan="8" style="text-align:center;color:var(--text-muted);padding:40px">Loadingâ€¦</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="ctrl-modal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('ctrl-modal')">âœ•</button>
    <h3 id="ctrl-modal-title">New Security Control</h3>
    <div class="form-group"><label>Title *</label><input id="c-title" /></div>
    <div class="form-group"><label>Description</label><textarea id="c-desc"></textarea></div>
    <div class="form-row">
      <div class="form-group">
        <label>Control Type</label>
        <select id="c-type"><option>Preventive</option><option>Detective</option><option>Corrective</option></select>
      </div>
      <div class="form-group">
        <label>Implementation Status</label>
        <select id="c-status"><option>Not Implemented</option><option>Partially Implemented</option><option>Implemented</option></select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>NIST Mapping</label><input id="c-nist" placeholder="e.g. NIST SP 800-53 AC-1" /></div>
      <div class="form-group"><label>OWASP Mapping</label><input id="c-owasp" placeholder="e.g. ASVS 2.1.1" /></div>
    </div>
    <div class="form-group"><label>Owner</label><input id="c-owner" /></div>
    <div class="form-group"><label>Notes</label><textarea id="c-notes"></textarea></div>
    <div class="form-actions">
      <button class="btn btn-ghost" onclick="closeModal('ctrl-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveControl()">Save</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let editCtrlId = null;

async function loadControls() {
  const type = document.getElementById("filter-type").value;
  const st   = document.getElementById("filter-status").value;
  let url = "/api/controls/?";
  if (type) url += `type=${encodeURIComponent(type)}&`;
  if (st)   url += `status=${encodeURIComponent(st)}`;
  const ctrls = await API.get(url);
  const tbody = document.getElementById("ctrl-tbody");
  if (!ctrls.length) {
    tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="icon">ðŸ”’</div><p>No controls recorded yet.</p></div></td></tr>`;
    return;
  }
  tbody.innerHTML = ctrls.map(c => `
    <tr>
      <td><code style="font-size:11px;color:var(--text-muted)">${c.control_id}</code></td>
      <td>${c.title}</td>
      <td><span class="badge badge-info">${c.control_type}</span></td>
      <td style="font-size:12px;color:var(--text-muted)">${c.nist_mapping || 'â€”'}</td>
      <td style="font-size:12px;color:var(--text-muted)">${c.owasp_mapping || 'â€”'}</td>
      <td>${statusBadge(c.implementation_status)}</td>
      <td style="font-size:12px;color:var(--text-muted)">${c.owner || 'â€”'}</td>
      <td>
        <button class="btn btn-ghost btn-sm" onclick='editCtrl(${JSON.stringify(c)})'>Edit</button>
        <button class="btn btn-danger btn-sm" onclick="deleteCtrl(${c.id})">Del</button>
      </td>
    </tr>`).join("");
}

function editCtrl(c) {
  editCtrlId = c.id;
  document.getElementById("ctrl-modal-title").textContent = "Edit Control";
  document.getElementById("c-title").value  = c.title;
  document.getElementById("c-desc").value   = c.description || "";
  document.getElementById("c-type").value   = c.control_type;
  document.getElementById("c-status").value = c.implementation_status;
  document.getElementById("c-nist").value   = c.nist_mapping || "";
  document.getElementById("c-owasp").value  = c.owasp_mapping || "";
  document.getElementById("c-owner").value  = c.owner || "";
  document.getElementById("c-notes").value  = c.notes || "";
  openModal("ctrl-modal");
}

async function saveControl() {
  const payload = {
    title: document.getElementById("c-title").value.trim(),
    description: document.getElementById("c-desc").value,
    control_type: document.getElementById("c-type").value,
    implementation_status: document.getElementById("c-status").value,
    nist_mapping: document.getElementById("c-nist").value,
    owasp_mapping: document.getElementById("c-owasp").value,
    owner: document.getElementById("c-owner").value,
    notes: document.getElementById("c-notes").value,
  };
  if (!payload.title) return showAlert("Title is required.", "error");
  const result = editCtrlId
    ? await API.put(`/api/controls/${editCtrlId}`, payload)
    : await API.post("/api/controls/", payload);
  if (result.error) return showAlert(result.error, "error");
  closeModal("ctrl-modal");
  editCtrlId = null;
  loadControls();
  showAlert("Control saved.");
}

async function deleteCtrl(id) {
  if (!confirm("Delete this control?")) return;
  await API.delete(`/api/controls/${id}`);
  loadControls();
  showAlert("Control deleted.");
}

loadControls();
</script>
{% endblock %}
